# Azure Deployment Plan — jobs_modernization (Core, IaaS, PaaS)

## Goal

Deploy the infrastructure in three layers using Azure CLI and Bicep:

- Core (networking, Key Vault, Log Analytics, private DNS)
- IaaS (VMSS, SQL VM, Application Gateway)
- PaaS (App Service + SQL Database, integrations)

Validate with What-If and parameterize using the provided .bicepparam files. Use Key Vault for secrets and generated certificate for App Gateway.

## Project Information

- Codebase IaC:
  - Core: [iac/bicep/core](iac/bicep/core) — subscription-scope entry point [iac/bicep/core/main.bicep](iac/bicep/core/main.bicep), params [iac/bicep/core/parameters.bicepparam](iac/bicep/core/parameters.bicepparam)
  - IaaS: [iac/bicep/iaas](iac/bicep/iaas) — subscription-scope entry point [iac/bicep/iaas/main.bicep](iac/bicep/iaas/main.bicep), params [iac/bicep/iaas/parameters.bicepparam](iac/bicep/iaas/parameters.bicepparam)
  - PaaS: [iac/bicep/paas](iac/bicep/paas) — subscription-scope entry point [iac/bicep/paas/main.bicep](iac/bicep/paas/main.bicep), params [iac/bicep/paas/parameters.bicepparam](iac/bicep/paas/parameters.bicepparam) + env-specific bicepparams
- Target scope: Subscription (each module creates its own resource group)
- Default environment: `dev` (override via parameters as needed)

## Azure Resources Architecture (high level)

- Core creates hub VNet + subnets (FE, DATA, Private Endpoints), Key Vault, Log Analytics, Private DNS
- IaaS consumes Core VNet/subnets and Log Analytics; provisions VMSS, SQL VM, and Application Gateway (uses cert)
- PaaS consumes Core Private Endpoint subnet, Log Analytics, Key Vault; provisions App Service and SQL Database

## Prerequisites

- Azure CLI installed and logged in (`az login`)
- Subscription selected (`az account set --subscription <SUBSCRIPTION_ID_OR_NAME>`)
- Sufficient permissions to create resource groups and resources at subscription scope

## Execution Steps

1) Core — Subscription deployment

- Validate (What-If):

  ```powershell
  az deployment sub what-if `
    --name jobsite-core-dev `
    --location eastus `
    --template-file iac/bicep/core/main.bicep `
    --parameters @iac/bicep/core/parameters.bicepparam
  ```

- Deploy:

  ```powershell
  az deployment sub create `
    --name jobsite-core-dev `
    --location eastus `
    --template-file iac/bicep/core/main.bicep `
    --parameters @iac/bicep/core/parameters.bicepparam
  ```

- Note: Update defaults in [iac/bicep/core/parameters.bicepparam](iac/bicep/core/parameters.bicepparam) (e.g., `sqlAdminPassword`, VPN cert) before running.

1) IaaS — Group deployment (depends on Core outputs)

- Option A (recommended): use the helper script to generate secrets and wire parameters from Core outputs
  - Review and set `kvName` in [iac/deploy-iaas.ps1](iac/deploy-iaas.ps1)
  - Run:

    ```powershell
    pwsh iac/deploy-iaas.ps1
    ```

- Option B (manual az CLI):
  - Retrieve Core outputs and set variables:

    ```powershell
    $core = az deployment group show --name jobsite-core-dev --resource-group jobsite-core-dev-rg -o json | ConvertFrom-Json
    $vnetId = $core.properties.outputs.vnetId.value
    $frontendSubnetId = $core.properties.outputs.frontendSubnetId.value
    $dataSubnetId = $core.properties.outputs.dataSubnetId.value
    $logAnalyticsWorkspaceId = $core.properties.outputs.logAnalyticsWorkspaceId.value
    ```

  - Generate passwords and App Gateway cert (or pull from Key Vault) then deploy:

    ```powershell
    az deployment group what-if `
      --name jobsite-iaas-dev `
      --resource-group jobsite-iaas-dev-rg `
      --template-file iac/bicep/iaas/main.bicep `
      --parameters environment=dev vnetId=$vnetId frontendSubnetId=$frontendSubnetId dataSubnetId=$dataSubnetId logAnalyticsWorkspaceId=$logAnalyticsWorkspaceId

    az deployment group create `
      --name jobsite-iaas-dev `
      --resource-group jobsite-iaas-dev-rg `
      --template-file iac/bicep/iaas/main.bicep `
      --parameters environment=dev vnetId=$vnetId frontendSubnetId=$frontendSubnetId dataSubnetId=$dataSubnetId logAnalyticsWorkspaceId=$logAnalyticsWorkspaceId `
      --parameters sqlAdminPassword=<secure> vmAdminPassword=<secure> appGatewayCertData=<base64pfx> appGatewayCertPassword=<secure>
    ```

1) PaaS — Group deployment (depends on Core outputs)

- Ensure the following values from Core are available: `vnetId`, `peSubnetId`, `keyVaultId`, `keyVaultName`, `logAnalyticsWorkspaceId`, `privateDnsZoneId`, `privateDnsZoneName`
- Validate (What-If):

  ```powershell
  az deployment sub what-if `
    --name jobsite-paas-dev `
    --location eastus `
    --template-file iac/bicep/paas/main.bicep `
    --parameters @iac/bicep/paas/parameters.bicepparam
  ```

- Deploy:

  ```powershell
  az deployment sub create `
    --name jobsite-paas-dev `
    --location eastus `
    --template-file iac/bicep/paas/main.bicep `
    --parameters @iac/bicep/paas/parameters.bicepparam
  ```

- Alternatively use env-specific files: [iac/bicep/paas/main.dev.bicepparam](iac/bicep/paas/main.dev.bicepparam), staging or prod variants

## Notes & Recommendations

- Replace placeholder values in all `.bicepparam` files (e.g., `{subscriptionId}`, `{uniqueSuffix}`, sample passwords) before deployment
- Keep secrets in Key Vault; do not commit real passwords/certificates
- Always run What-If before Create for each scope
- Run Core once per environment; then reuse outputs for IaaS and PaaS
- Post-deploy: validate App Service reachability, VMSS health, and SQL connectivity; enable diagnostic settings to Log Analytics as needed

## Rollback / Re-run

- Bicep deployments are idempotent; re-running updates drifted resources
- To remove stacks, delete resource groups created by each layer (core/iaas/paas) if appropriate for the environment
