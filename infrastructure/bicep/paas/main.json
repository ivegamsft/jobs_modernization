{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.39.26.7824",
      "templateHash": "15655654707889554047"
    }
  },
  "parameters": {
    "environment": {
      "type": "string",
      "defaultValue": "dev"
    },
    "applicationName": {
      "type": "string",
      "defaultValue": "jobsite"
    },
    "location": {
      "type": "string",
      "defaultValue": "eastus"
    },
    "appServiceSku": {
      "type": "string",
      "defaultValue": "S1"
    },
    "sqlDatabaseEdition": {
      "type": "string",
      "defaultValue": "Standard"
    },
    "sqlServiceObjective": {
      "type": "string",
      "defaultValue": "S1"
    },
    "sqlAdminUsername": {
      "type": "string",
      "defaultValue": "jobsiteadmin"
    },
    "sqlAdminPassword": {
      "type": "securestring",
      "defaultValue": "[newGuid()]"
    },
    "peSubnetId": {
      "type": "string"
    },
    "logAnalyticsWorkspaceId": {
      "type": "string"
    },
    "resourceGroupName": {
      "type": "string",
      "defaultValue": "[format('{0}-paas-{1}-rg', parameters('applicationName'), parameters('environment'))]"
    },
    "tags": {
      "type": "object",
      "defaultValue": {
        "Application": "JobSite",
        "Environment": "[parameters('environment')]",
        "ManagedBy": "Bicep"
      }
    }
  },
  "resources": [
    {
      "type": "Microsoft.Resources/resourceGroups",
      "apiVersion": "2024-03-01",
      "name": "[parameters('resourceGroupName')]",
      "location": "[parameters('location')]",
      "tags": "[parameters('tags')]"
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "paas-resources-deployment",
      "resourceGroup": "[parameters('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "environment": {
            "value": "[parameters('environment')]"
          },
          "applicationName": {
            "value": "[parameters('applicationName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "appServiceSku": {
            "value": "[parameters('appServiceSku')]"
          },
          "sqlDatabaseEdition": {
            "value": "[parameters('sqlDatabaseEdition')]"
          },
          "sqlServiceObjective": {
            "value": "[parameters('sqlServiceObjective')]"
          },
          "sqlAdminUsername": {
            "value": "[parameters('sqlAdminUsername')]"
          },
          "sqlAdminPassword": {
            "value": "[parameters('sqlAdminPassword')]"
          },
          "peSubnetId": {
            "value": "[parameters('peSubnetId')]"
          },
          "logAnalyticsWorkspaceId": {
            "value": "[parameters('logAnalyticsWorkspaceId')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "1167530391983243788"
            }
          },
          "parameters": {
            "environment": {
              "type": "string"
            },
            "applicationName": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "appServiceSku": {
              "type": "string"
            },
            "sqlDatabaseEdition": {
              "type": "string"
            },
            "sqlServiceObjective": {
              "type": "string"
            },
            "sqlAdminUsername": {
              "type": "string"
            },
            "sqlAdminPassword": {
              "type": "securestring"
            },
            "peSubnetId": {
              "type": "string"
            },
            "logAnalyticsWorkspaceId": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            }
          },
          "variables": {
            "uniqueSuffix": "[uniqueString(resourceGroup().id)]",
            "appServiceName": "[format('{0}-app-{1}-{2}', parameters('applicationName'), parameters('environment'), variables('uniqueSuffix'))]",
            "appServicePlanName": "[format('{0}-asp-{1}', parameters('applicationName'), parameters('environment'))]",
            "sqlServerName": "[format('{0}-sql-{1}-{2}', parameters('applicationName'), parameters('environment'), variables('uniqueSuffix'))]",
            "sqlDatabaseName": "[format('{0}db', parameters('applicationName'))]",
            "appInsightsName": "[format('{0}-ai-{1}', parameters('applicationName'), parameters('environment'))]",
            "privateEndpointName": "[format('{0}-pe', variables('appServiceName'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/serverfarms",
              "apiVersion": "2023-01-01",
              "name": "[variables('appServicePlanName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "[parameters('appServiceSku')]"
              },
              "properties": {}
            },
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2023-01-01",
              "name": "[variables('appServiceName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]",
                "httpsOnly": true,
                "siteConfig": {
                  "netFrameworkVersion": "v4.8",
                  "minTlsVersion": "1.2",
                  "http20Enabled": true
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]"
              ]
            },
            {
              "type": "Microsoft.Insights/components",
              "apiVersion": "2020-02-02",
              "name": "[variables('appInsightsName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "web",
              "properties": {
                "Application_Type": "web",
                "WorkspaceResourceId": "[parameters('logAnalyticsWorkspaceId')]"
              }
            },
            {
              "type": "Microsoft.Sql/servers",
              "apiVersion": "2021-11-01",
              "name": "[variables('sqlServerName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "administratorLogin": "[parameters('sqlAdminUsername')]",
                "administratorLoginPassword": "[parameters('sqlAdminPassword')]",
                "version": "12.0",
                "minimalTlsVersion": "1.2",
                "publicNetworkAccess": "Disabled"
              }
            },
            {
              "type": "Microsoft.Sql/servers/databases",
              "apiVersion": "2021-11-01",
              "name": "[format('{0}/{1}', variables('sqlServerName'), variables('sqlDatabaseName'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "[parameters('sqlServiceObjective')]",
                "tier": "[parameters('sqlDatabaseEdition')]"
              },
              "properties": {
                "collation": "SQL_Latin1_General_CP1_CI_AS",
                "maxSizeBytes": 268435456000
              },
              "dependsOn": [
                "[resourceId('Microsoft.Sql/servers', variables('sqlServerName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2023-11-01",
              "name": "[variables('privateEndpointName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('peSubnetId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "[format('{0}-connection', variables('privateEndpointName'))]",
                    "properties": {
                      "privateLinkServiceId": "[resourceId('Microsoft.Sql/servers', variables('sqlServerName'))]",
                      "groupIds": [
                        "sqlServer"
                      ]
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Sql/servers', variables('sqlServerName'))]"
              ]
            }
          ],
          "outputs": {
            "appServiceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Web/sites', variables('appServiceName'))]"
            },
            "appServiceName": {
              "type": "string",
              "value": "[variables('appServiceName')]"
            },
            "appServicePlanId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]"
            },
            "sqlServerId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Sql/servers', variables('sqlServerName'))]"
            },
            "sqlServerName": {
              "type": "string",
              "value": "[variables('sqlServerName')]"
            },
            "sqlDatabaseId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Sql/servers/databases', variables('sqlServerName'), variables('sqlDatabaseName'))]"
            },
            "sqlDatabaseName": {
              "type": "string",
              "value": "[variables('sqlDatabaseName')]"
            },
            "appInsightsId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Insights/components', variables('appInsightsName'))]"
            },
            "appInsightsInstrumentationKey": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Insights/components', variables('appInsightsName')), '2020-02-02').InstrumentationKey]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('resourceGroupName'))]"
      ]
    }
  ],
  "outputs": {
    "resourceGroupName": {
      "type": "string",
      "value": "[parameters('resourceGroupName')]"
    },
    "appServiceId": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'paas-resources-deployment'), '2025-04-01').outputs.appServiceId.value]"
    },
    "appServiceName": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'paas-resources-deployment'), '2025-04-01').outputs.appServiceName.value]"
    },
    "appServicePlanId": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'paas-resources-deployment'), '2025-04-01').outputs.appServicePlanId.value]"
    },
    "sqlServerId": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'paas-resources-deployment'), '2025-04-01').outputs.sqlServerId.value]"
    },
    "sqlServerName": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'paas-resources-deployment'), '2025-04-01').outputs.sqlServerName.value]"
    },
    "sqlDatabaseId": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'paas-resources-deployment'), '2025-04-01').outputs.sqlDatabaseId.value]"
    },
    "sqlDatabaseName": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'paas-resources-deployment'), '2025-04-01').outputs.sqlDatabaseName.value]"
    },
    "appInsightsId": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'paas-resources-deployment'), '2025-04-01').outputs.appInsightsId.value]"
    },
    "appInsightsInstrumentationKey": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'paas-resources-deployment'), '2025-04-01').outputs.appInsightsInstrumentationKey.value]"
    }
  }
}