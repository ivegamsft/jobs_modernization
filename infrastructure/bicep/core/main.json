{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.39.26.7824",
      "templateHash": "15256089005474970015"
    }
  },
  "parameters": {
    "environment": {
      "type": "string",
      "defaultValue": "dev"
    },
    "applicationName": {
      "type": "string",
      "defaultValue": "jobsite"
    },
    "location": {
      "type": "string",
      "defaultValue": "eastus"
    },
    "vnetAddressPrefix": {
      "type": "string",
      "defaultValue": "10.50.0.0/24"
    },
    "sqlAdminUsername": {
      "type": "string",
      "defaultValue": "jobsiteadmin"
    },
    "sqlAdminPassword": {
      "type": "securestring",
      "defaultValue": "[newGuid()]"
    },
    "vpnRootCertificate": {
      "type": "string",
      "defaultValue": ""
    },
    "vpnClientAddressPool": {
      "type": "string",
      "defaultValue": "172.16.0.0/24"
    },
    "tags": {
      "type": "object",
      "defaultValue": {
        "Application": "JobSite",
        "Environment": "[parameters('environment')]",
        "ManagedBy": "Bicep"
      }
    }
  },
  "variables": {
    "resourceGroupName": "[format('{0}-core-{1}-rg', parameters('applicationName'), parameters('environment'))]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/resourceGroups",
      "apiVersion": "2024-03-01",
      "name": "[variables('resourceGroupName')]",
      "location": "[parameters('location')]",
      "tags": "[parameters('tags')]"
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "core-resources-deployment",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "environment": {
            "value": "[parameters('environment')]"
          },
          "applicationName": {
            "value": "[parameters('applicationName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "vnetAddressPrefix": {
            "value": "[parameters('vnetAddressPrefix')]"
          },
          "sqlAdminUsername": {
            "value": "[parameters('sqlAdminUsername')]"
          },
          "sqlAdminPassword": {
            "value": "[parameters('sqlAdminPassword')]"
          },
          "vpnRootCertificate": {
            "value": "[parameters('vpnRootCertificate')]"
          },
          "vpnClientAddressPool": {
            "value": "[parameters('vpnClientAddressPool')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "3961340997340699281"
            }
          },
          "parameters": {
            "environment": {
              "type": "string"
            },
            "applicationName": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "vnetAddressPrefix": {
              "type": "string"
            },
            "sqlAdminUsername": {
              "type": "string"
            },
            "sqlAdminPassword": {
              "type": "securestring"
            },
            "vpnRootCertificate": {
              "type": "string"
            },
            "vpnClientAddressPool": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            }
          },
          "variables": {
            "uniqueSuffix": "[uniqueString(resourceGroup().id)]",
            "resourcePrefix": "[format('{0}-{1}', parameters('applicationName'), parameters('environment'))]",
            "subnetConfig": {
              "frontend": {
                "name": "snet-fe",
                "prefix": "10.50.0.0/27"
              },
              "data": {
                "name": "snet-data",
                "prefix": "10.50.0.32/27"
              },
              "vpnGateway": {
                "name": "GatewaySubnet",
                "prefix": "10.50.0.64/27"
              },
              "privateEndpoint": {
                "name": "snet-pe",
                "prefix": "10.50.0.96/27"
              },
              "githubRunners": {
                "name": "snet-gh-runners",
                "prefix": "10.50.0.128/27"
              },
              "aks": {
                "name": "snet-aks",
                "prefix": "10.50.0.160/27"
              },
              "containerApps": {
                "name": "snet-ca",
                "prefix": "10.50.0.192/27"
              }
            },
            "natGatewayName": "[format('{0}-nat-{1}', variables('resourcePrefix'), variables('uniqueSuffix'))]",
            "publicIpNatName": "[format('{0}-pip-nat-{1}', variables('resourcePrefix'), variables('uniqueSuffix'))]",
            "vnetName": "[format('{0}-vnet-{1}', variables('resourcePrefix'), variables('uniqueSuffix'))]",
            "vpnGatewayName": "[format('{0}-vpn-gw-{1}', variables('resourcePrefix'), variables('uniqueSuffix'))]",
            "publicIpVpnName": "[format('{0}-pip-vpn-{1}', variables('resourcePrefix'), variables('uniqueSuffix'))]",
            "privateDnsZoneName": "[format('{0}.internal', parameters('applicationName'))]",
            "keyVaultName": "[format('kv-{0}-{1}', take(variables('uniqueSuffix'), 8), parameters('environment'))]",
            "logAnalyticsWorkspaceName": "[format('{0}-la-{1}', variables('resourcePrefix'), variables('uniqueSuffix'))]"
          },
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2022-10-01",
              "name": "[variables('logAnalyticsWorkspaceName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "retentionInDays": 30,
                "sku": {
                  "name": "PerGB2018"
                }
              }
            },
            {
              "type": "Microsoft.Network/publicIPAddresses",
              "apiVersion": "2023-11-01",
              "name": "[variables('publicIpNatName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "Standard"
              },
              "properties": {
                "publicIPAllocationMethod": "Static",
                "idleTimeoutInMinutes": 4
              }
            },
            {
              "type": "Microsoft.Network/natGateways",
              "apiVersion": "2023-11-01",
              "name": "[variables('natGatewayName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "Standard"
              },
              "properties": {
                "idleTimeoutInMinutes": 4,
                "publicIpAddresses": [
                  {
                    "id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIpNatName'))]"
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIpNatName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/publicIPAddresses",
              "apiVersion": "2023-11-01",
              "name": "[variables('publicIpVpnName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "Standard"
              },
              "properties": {
                "publicIPAllocationMethod": "Static"
              }
            },
            {
              "type": "Microsoft.Network/virtualNetworks",
              "apiVersion": "2023-11-01",
              "name": "[variables('vnetName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "addressSpace": {
                  "addressPrefixes": [
                    "[parameters('vnetAddressPrefix')]"
                  ]
                },
                "subnets": [
                  {
                    "name": "[variables('subnetConfig').frontend.name]",
                    "properties": {
                      "addressPrefix": "[variables('subnetConfig').frontend.prefix]",
                      "natGateway": {
                        "id": "[resourceId('Microsoft.Network/natGateways', variables('natGatewayName'))]"
                      },
                      "privateEndpointNetworkPolicies": "Disabled",
                      "privateLinkServiceNetworkPolicies": "Enabled"
                    }
                  },
                  {
                    "name": "[variables('subnetConfig').data.name]",
                    "properties": {
                      "addressPrefix": "[variables('subnetConfig').data.prefix]",
                      "natGateway": {
                        "id": "[resourceId('Microsoft.Network/natGateways', variables('natGatewayName'))]"
                      },
                      "privateEndpointNetworkPolicies": "Disabled",
                      "privateLinkServiceNetworkPolicies": "Enabled"
                    }
                  },
                  {
                    "name": "[variables('subnetConfig').vpnGateway.name]",
                    "properties": {
                      "addressPrefix": "[variables('subnetConfig').vpnGateway.prefix]",
                      "privateEndpointNetworkPolicies": "Disabled",
                      "privateLinkServiceNetworkPolicies": "Enabled"
                    }
                  },
                  {
                    "name": "[variables('subnetConfig').privateEndpoint.name]",
                    "properties": {
                      "addressPrefix": "[variables('subnetConfig').privateEndpoint.prefix]",
                      "privateEndpointNetworkPolicies": "Disabled",
                      "privateLinkServiceNetworkPolicies": "Enabled"
                    }
                  },
                  {
                    "name": "[variables('subnetConfig').githubRunners.name]",
                    "properties": {
                      "addressPrefix": "[variables('subnetConfig').githubRunners.prefix]",
                      "natGateway": {
                        "id": "[resourceId('Microsoft.Network/natGateways', variables('natGatewayName'))]"
                      },
                      "privateEndpointNetworkPolicies": "Disabled",
                      "privateLinkServiceNetworkPolicies": "Enabled"
                    }
                  },
                  {
                    "name": "[variables('subnetConfig').aks.name]",
                    "properties": {
                      "addressPrefix": "[variables('subnetConfig').aks.prefix]",
                      "natGateway": {
                        "id": "[resourceId('Microsoft.Network/natGateways', variables('natGatewayName'))]"
                      },
                      "privateEndpointNetworkPolicies": "Disabled",
                      "privateLinkServiceNetworkPolicies": "Enabled"
                    }
                  },
                  {
                    "name": "[variables('subnetConfig').containerApps.name]",
                    "properties": {
                      "addressPrefix": "[variables('subnetConfig').containerApps.prefix]",
                      "natGateway": {
                        "id": "[resourceId('Microsoft.Network/natGateways', variables('natGatewayName'))]"
                      },
                      "privateEndpointNetworkPolicies": "Disabled",
                      "privateLinkServiceNetworkPolicies": "Enabled"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/natGateways', variables('natGatewayName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/virtualNetworkGateways",
              "apiVersion": "2023-11-01",
              "name": "[variables('vpnGatewayName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "gatewayType": "Vpn",
                "vpnType": "RouteBased",
                "sku": {
                  "name": "VpnGw1",
                  "tier": "VpnGw1"
                },
                "ipConfigurations": [
                  {
                    "name": "vnetGatewayConfig",
                    "properties": {
                      "privateIPAllocationMethod": "Dynamic",
                      "subnet": {
                        "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('vnetName'), variables('subnetConfig').vpnGateway.name)]"
                      },
                      "publicIPAddress": {
                        "id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIpVpnName'))]"
                      }
                    }
                  }
                ],
                "vpnClientConfiguration": "[if(not(equals(parameters('vpnRootCertificate'), '')), createObject('vpnClientAddressPool', createObject('addressPrefixes', createArray(parameters('vpnClientAddressPool'))), 'vpnClientProtocols', createArray('IkeV2', 'OpenVPN'), 'vpnAuthenticationTypes', createArray('Certificate', 'AAD'), 'aadTenant', format('{0}{1}/', environment().authentication.loginEndpoint, subscription().tenantId), 'aadAudience', '41b23e61-6c1e-4545-b367-cd1864d40eab', 'aadIssuer', format('https://sts.windows.net/{0}/', subscription().tenantId), 'vpnClientRootCertificates', createArray(createObject('name', 'RootCert', 'properties', createObject('publicCertData', parameters('vpnRootCertificate'))))), null())]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIpVpnName'))]",
                "[resourceId('Microsoft.Network/virtualNetworks', variables('vnetName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateDnsZones",
              "apiVersion": "2020-06-01",
              "name": "[variables('privateDnsZoneName')]",
              "location": "global",
              "tags": "[parameters('tags')]"
            },
            {
              "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
              "apiVersion": "2020-06-01",
              "name": "[format('{0}/{1}', variables('privateDnsZoneName'), format('{0}-vnetlink', variables('privateDnsZoneName')))]",
              "location": "global",
              "tags": "[parameters('tags')]",
              "properties": {
                "registrationEnabled": true,
                "virtualNetwork": {
                  "id": "[resourceId('Microsoft.Network/virtualNetworks', variables('vnetName'))]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', variables('privateDnsZoneName'))]",
                "[resourceId('Microsoft.Network/virtualNetworks', variables('vnetName'))]"
              ]
            },
            {
              "type": "Microsoft.KeyVault/vaults",
              "apiVersion": "2023-07-01",
              "name": "[variables('keyVaultName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "tenantId": "[subscription().tenantId]",
                "sku": {
                  "family": "A",
                  "name": "standard"
                },
                "accessPolicies": [],
                "enableRbacAuthorization": true,
                "networkAcls": {
                  "defaultAction": "Allow",
                  "bypass": "AzureServices"
                }
              }
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2023-07-01",
              "name": "[format('{0}/{1}', variables('keyVaultName'), 'sql-admin-username')]",
              "properties": {
                "value": "[parameters('sqlAdminUsername')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]"
              ]
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2023-07-01",
              "name": "[format('{0}/{1}', variables('keyVaultName'), 'sql-admin-password')]",
              "properties": {
                "value": "[parameters('sqlAdminPassword')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]"
              ]
            }
          ],
          "outputs": {
            "vnetId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/virtualNetworks', variables('vnetName'))]"
            },
            "vnetName": {
              "type": "string",
              "value": "[variables('vnetName')]"
            },
            "frontendSubnetId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('vnetName'), variables('subnetConfig').frontend.name)]"
            },
            "dataSubnetId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('vnetName'), variables('subnetConfig').data.name)]"
            },
            "peSubnetId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('vnetName'), variables('subnetConfig').privateEndpoint.name)]"
            },
            "keyVaultId": {
              "type": "string",
              "value": "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]"
            },
            "keyVaultName": {
              "type": "string",
              "value": "[variables('keyVaultName')]"
            },
            "privateDnsZoneId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/privateDnsZones', variables('privateDnsZoneName'))]"
            },
            "privateDnsZoneName": {
              "type": "string",
              "value": "[variables('privateDnsZoneName')]"
            },
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsWorkspaceName'))]"
            },
            "logAnalyticsWorkspaceName": {
              "type": "string",
              "value": "[variables('logAnalyticsWorkspaceName')]"
            },
            "natGatewayPublicIp": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Network/publicIPAddresses', variables('publicIpNatName')), '2023-11-01').ipAddress]"
            },
            "vpnGatewayPublicIp": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Network/publicIPAddresses', variables('publicIpVpnName')), '2023-11-01').ipAddress]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('resourceGroupName'))]"
      ]
    }
  ],
  "outputs": {
    "resourceGroupName": {
      "type": "string",
      "value": "[variables('resourceGroupName')]"
    },
    "vnetId": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'core-resources-deployment'), '2025-04-01').outputs.vnetId.value]"
    },
    "vnetName": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'core-resources-deployment'), '2025-04-01').outputs.vnetName.value]"
    },
    "frontendSubnetId": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'core-resources-deployment'), '2025-04-01').outputs.frontendSubnetId.value]"
    },
    "dataSubnetId": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'core-resources-deployment'), '2025-04-01').outputs.dataSubnetId.value]"
    },
    "peSubnetId": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'core-resources-deployment'), '2025-04-01').outputs.peSubnetId.value]"
    },
    "keyVaultId": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'core-resources-deployment'), '2025-04-01').outputs.keyVaultId.value]"
    },
    "keyVaultName": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'core-resources-deployment'), '2025-04-01').outputs.keyVaultName.value]"
    },
    "privateDnsZoneId": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'core-resources-deployment'), '2025-04-01').outputs.privateDnsZoneId.value]"
    },
    "privateDnsZoneName": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'core-resources-deployment'), '2025-04-01').outputs.privateDnsZoneName.value]"
    },
    "logAnalyticsWorkspaceId": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'core-resources-deployment'), '2025-04-01').outputs.logAnalyticsWorkspaceId.value]"
    },
    "logAnalyticsWorkspaceName": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'core-resources-deployment'), '2025-04-01').outputs.logAnalyticsWorkspaceName.value]"
    },
    "natGatewayPublicIp": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'core-resources-deployment'), '2025-04-01').outputs.natGatewayPublicIp.value]"
    },
    "vpnGatewayPublicIp": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'core-resources-deployment'), '2025-04-01').outputs.vpnGatewayPublicIp.value]"
    }
  }
}