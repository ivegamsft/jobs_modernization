{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.39.26.7824",
      "templateHash": "15374009910687394031"
    }
  },
  "parameters": {
    "environment": {
      "type": "string",
      "metadata": {
        "description": "Environment name (dev, staging, prod)"
      }
    },
    "applicationName": {
      "type": "string",
      "defaultValue": "jobsite",
      "metadata": {
        "description": "Application name (no spaces)"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Azure location for resources"
      }
    },
    "vnetAddressPrefix": {
      "type": "string",
      "defaultValue": "10.50.0.0/16",
      "metadata": {
        "description": "VNet address space"
      }
    },
    "sqlAdminUsername": {
      "type": "string",
      "metadata": {
        "description": "Administrator username for SQL Server"
      }
    },
    "sqlAdminPassword": {
      "type": "securestring",
      "metadata": {
        "description": "Administrator password for SQL Server"
      }
    },
    "vpnRootCertificate": {
      "type": "string",
      "metadata": {
        "description": "VPN root certificate (public key in base64)"
      }
    },
    "vpnClientAddressPool": {
      "type": "string",
      "defaultValue": "10.70.0.0/24",
      "metadata": {
        "description": "VPN client address pool (must be in a different range than VNet)"
      }
    },
    "tags": {
      "type": "object",
      "defaultValue": {
        "environment": "[parameters('environment')]",
        "application": "[parameters('applicationName')]",
        "deployedDate": "[utcNow('u')]",
        "deployedBy": "Bicep",
        "component": "core"
      },
      "metadata": {
        "description": "Tags to apply to all resources"
      }
    }
  },
  "variables": {
    "uniqueSuffix": "[uniqueString(resourceGroup().id)]",
    "resourcePrefix": "[format('{0}-{1}', parameters('applicationName'), parameters('environment'))]",
    "subnetConfig": {
      "frontend": {
        "name": "snet-fe",
        "prefix": "10.50.0.0/27"
      },
      "data": {
        "name": "snet-data",
        "prefix": "10.50.0.32/27"
      },
      "vpn": {
        "name": "GatewaySubnet",
        "prefix": "10.50.0.64/27"
      },
      "privateEndpoint": {
        "name": "snet-pe",
        "prefix": "10.50.0.96/27"
      },
      "githubRunners": {
        "name": "snet-gh-runners",
        "prefix": "10.50.0.128/27"
      },
      "aks": {
        "name": "snet-aks",
        "prefix": "10.50.0.160/27"
      },
      "containerApps": {
        "name": "snet-ca",
        "prefix": "10.50.0.192/27"
      }
    },
    "natGatewayName": "[format('{0}-nat-{1}', variables('resourcePrefix'), variables('uniqueSuffix'))]",
    "publicIpNatName": "[format('{0}-pip-nat-{1}', variables('resourcePrefix'), variables('uniqueSuffix'))]",
    "vnetName": "[format('{0}-vnet-{1}', variables('resourcePrefix'), variables('uniqueSuffix'))]",
    "vpnGatewayName": "[format('{0}-vpn-gw-{1}', variables('resourcePrefix'), variables('uniqueSuffix'))]",
    "publicIpVpnName": "[format('{0}-pip-vpn-{1}', variables('resourcePrefix'), variables('uniqueSuffix'))]",
    "privateDnsZoneName": "jobsite.internal",
    "keyVaultName": "[format('{0}-kv-{1}', variables('resourcePrefix'), variables('uniqueSuffix'))]",
    "logAnalyticsWorkspaceName": "[format('{0}-la-{1}', variables('resourcePrefix'), variables('uniqueSuffix'))]"
  },
  "resources": [
    {
      "type": "Microsoft.OperationalInsights/workspaces",
      "apiVersion": "2022-10-01",
      "name": "[variables('logAnalyticsWorkspaceName')]",
      "location": "[parameters('location')]",
      "tags": "[parameters('tags')]",
      "properties": {
        "retentionInDays": 30,
        "sku": {
          "name": "PerGB2018"
        }
      }
    },
    {
      "type": "Microsoft.Network/virtualNetworks",
      "apiVersion": "2023-11-01",
      "name": "[variables('vnetName')]",
      "location": "[parameters('location')]",
      "tags": "[parameters('tags')]",
      "properties": {
        "addressSpace": {
          "addressPrefixes": [
            "[parameters('vnetAddressPrefix')]"
          ]
        },
        "subnets": [
          {
            "name": "[variables('subnetConfig').frontend.name]",
            "properties": {
              "addressPrefix": "[variables('subnetConfig').frontend.prefix]",
              "natGateway": {
                "id": "[resourceId('Microsoft.Network/natGateways', variables('natGatewayName'))]"
              },
              "privateEndpointNetworkPolicies": "Disabled",
              "privateLinkServiceNetworkPolicies": "Enabled"
            }
          },
          {
            "name": "[variables('subnetConfig').data.name]",
            "properties": {
              "addressPrefix": "[variables('subnetConfig').data.prefix]",
              "natGateway": {
                "id": "[resourceId('Microsoft.Network/natGateways', variables('natGatewayName'))]"
              },
              "privateEndpointNetworkPolicies": "Disabled",
              "privateLinkServiceNetworkPolicies": "Enabled"
            }
          },
          {
            "name": "[variables('subnetConfig').vpn.name]",
            "properties": {
              "addressPrefix": "[variables('subnetConfig').vpn.prefix]",
              "privateEndpointNetworkPolicies": "Disabled",
              "privateLinkServiceNetworkPolicies": "Enabled"
            }
          },
          {
            "name": "[variables('subnetConfig').privateEndpoint.name]",
            "properties": {
              "addressPrefix": "[variables('subnetConfig').privateEndpoint.prefix]",
              "privateEndpointNetworkPolicies": "Disabled",
              "privateLinkServiceNetworkPolicies": "Enabled"
            }
          },
          {
            "name": "[variables('subnetConfig').githubRunners.name]",
            "properties": {
              "addressPrefix": "[variables('subnetConfig').githubRunners.prefix]",
              "natGateway": {
                "id": "[resourceId('Microsoft.Network/natGateways', variables('natGatewayName'))]"
              },
              "privateEndpointNetworkPolicies": "Disabled",
              "privateLinkServiceNetworkPolicies": "Enabled"
            }
          },
          {
            "name": "[variables('subnetConfig').aks.name]",
            "properties": {
              "addressPrefix": "[variables('subnetConfig').aks.prefix]",
              "natGateway": {
                "id": "[resourceId('Microsoft.Network/natGateways', variables('natGatewayName'))]"
              },
              "privateEndpointNetworkPolicies": "Disabled",
              "privateLinkServiceNetworkPolicies": "Enabled"
            }
          },
          {
            "name": "[variables('subnetConfig').containerApps.name]",
            "properties": {
              "addressPrefix": "[variables('subnetConfig').containerApps.prefix]",
              "natGateway": {
                "id": "[resourceId('Microsoft.Network/natGateways', variables('natGatewayName'))]"
              },
              "privateEndpointNetworkPolicies": "Disabled",
              "privateLinkServiceNetworkPolicies": "Enabled"
            }
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.Network/natGateways', variables('natGatewayName'))]"
      ]
    },
    {
      "type": "Microsoft.Network/publicIPAddresses",
      "apiVersion": "2023-11-01",
      "name": "[variables('publicIpNatName')]",
      "location": "[parameters('location')]",
      "tags": "[parameters('tags')]",
      "sku": {
        "name": "Standard"
      },
      "properties": {
        "publicIPAllocationMethod": "Static",
        "idleTimeoutInMinutes": 4
      }
    },
    {
      "type": "Microsoft.Network/natGateways",
      "apiVersion": "2023-11-01",
      "name": "[variables('natGatewayName')]",
      "location": "[parameters('location')]",
      "tags": "[parameters('tags')]",
      "sku": {
        "name": "Standard"
      },
      "properties": {
        "idleTimeoutInMinutes": 4,
        "publicIpAddresses": [
          {
            "id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIpNatName'))]"
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIpNatName'))]"
      ]
    },
    {
      "type": "Microsoft.Network/publicIPAddresses",
      "apiVersion": "2023-11-01",
      "name": "[variables('publicIpVpnName')]",
      "location": "[parameters('location')]",
      "tags": "[parameters('tags')]",
      "sku": {
        "name": "Standard"
      },
      "properties": {
        "publicIPAllocationMethod": "Static"
      }
    },
    {
      "type": "Microsoft.Network/virtualNetworkGateways",
      "apiVersion": "2023-11-01",
      "name": "[variables('vpnGatewayName')]",
      "location": "[parameters('location')]",
      "tags": "[parameters('tags')]",
      "properties": {
        "gatewayType": "Vpn",
        "vpnType": "RouteBased",
        "sku": {
          "name": "VpnGw1",
          "tier": "VpnGw1"
        },
        "ipConfigurations": [
          {
            "name": "vnetGatewayConfig",
            "properties": {
              "publicIPAddress": {
                "id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIpVpnName'))]"
              },
              "subnet": {
                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('vnetName'), variables('subnetConfig').vpn.name)]"
              },
              "privateIPAllocationMethod": "Dynamic"
            }
          }
        ],
        "vpnClientConfiguration": {
          "vpnClientAddressPool": {
            "addressPrefixes": [
              "[parameters('vpnClientAddressPool')]"
            ]
          },
          "vpnClientProtocols": [
            "IkeV2",
            "OpenVPN"
          ],
          "vpnAuthenticationTypes": [
            "Certificate",
            "AAD"
          ],
          "aadTenant": "[format('{0}{1}/', environment().authentication.loginEndpoint, subscription().tenantId)]",
          "aadAudience": "41b23e61-6c1e-4545-b367-db180ea8d0ea",
          "aadIssuer": "[format('https://sts.windows.net/{0}/', subscription().tenantId)]",
          "radiusServers": [],
          "vpnClientRootCertificates": [
            {
              "name": "RootCert",
              "properties": {
                "publicCertData": "[parameters('vpnRootCertificate')]"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIpVpnName'))]",
        "[resourceId('Microsoft.Network/virtualNetworks', variables('vnetName'))]"
      ]
    },
    {
      "type": "Microsoft.Network/privateDnsZones",
      "apiVersion": "2020-06-01",
      "name": "[variables('privateDnsZoneName')]",
      "location": "global",
      "tags": "[parameters('tags')]"
    },
    {
      "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
      "apiVersion": "2020-06-01",
      "name": "[format('{0}/{1}', variables('privateDnsZoneName'), format('{0}-vnetlink', variables('privateDnsZoneName')))]",
      "location": "global",
      "tags": "[parameters('tags')]",
      "properties": {
        "registrationEnabled": true,
        "virtualNetwork": {
          "id": "[resourceId('Microsoft.Network/virtualNetworks', variables('vnetName'))]"
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Network/privateDnsZones', variables('privateDnsZoneName'))]",
        "[resourceId('Microsoft.Network/virtualNetworks', variables('vnetName'))]"
      ]
    },
    {
      "type": "Microsoft.KeyVault/vaults",
      "apiVersion": "2023-07-01",
      "name": "[variables('keyVaultName')]",
      "location": "[parameters('location')]",
      "tags": "[parameters('tags')]",
      "properties": {
        "tenantId": "[subscription().tenantId]",
        "sku": {
          "family": "A",
          "name": "standard"
        },
        "accessPolicies": [],
        "enableRbacAuthorization": true,
        "networkAcls": {
          "defaultAction": "Allow",
          "bypass": "AzureServices"
        }
      }
    },
    {
      "type": "Microsoft.KeyVault/vaults/secrets",
      "apiVersion": "2023-07-01",
      "name": "[format('{0}/{1}', variables('keyVaultName'), 'sql-admin-username')]",
      "properties": {
        "value": "[parameters('sqlAdminUsername')]"
      },
      "dependsOn": [
        "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]"
      ]
    },
    {
      "type": "Microsoft.KeyVault/vaults/secrets",
      "apiVersion": "2023-07-01",
      "name": "[format('{0}/{1}', variables('keyVaultName'), 'sql-admin-password')]",
      "properties": {
        "value": "[parameters('sqlAdminPassword')]"
      },
      "dependsOn": [
        "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]"
      ]
    }
  ],
  "outputs": {
    "vnetId": {
      "type": "string",
      "metadata": {
        "description": "Virtual Network ID"
      },
      "value": "[resourceId('Microsoft.Network/virtualNetworks', variables('vnetName'))]"
    },
    "vnetName": {
      "type": "string",
      "metadata": {
        "description": "Virtual Network Name"
      },
      "value": "[variables('vnetName')]"
    },
    "frontendSubnetId": {
      "type": "string",
      "metadata": {
        "description": "Frontend Subnet ID"
      },
      "value": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('vnetName'), variables('subnetConfig').frontend.name)]"
    },
    "dataSubnetId": {
      "type": "string",
      "metadata": {
        "description": "Data Subnet ID"
      },
      "value": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('vnetName'), variables('subnetConfig').data.name)]"
    },
    "peSubnetId": {
      "type": "string",
      "metadata": {
        "description": "Private Endpoint Subnet ID"
      },
      "value": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('vnetName'), variables('subnetConfig').privateEndpoint.name)]"
    },
    "keyVaultId": {
      "type": "string",
      "metadata": {
        "description": "Key Vault ID"
      },
      "value": "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]"
    },
    "keyVaultName": {
      "type": "string",
      "metadata": {
        "description": "Key Vault Name"
      },
      "value": "[variables('keyVaultName')]"
    },
    "privateDnsZoneId": {
      "type": "string",
      "metadata": {
        "description": "Private DNS Zone ID"
      },
      "value": "[resourceId('Microsoft.Network/privateDnsZones', variables('privateDnsZoneName'))]"
    },
    "privateDnsZoneName": {
      "type": "string",
      "metadata": {
        "description": "Private DNS Zone Name"
      },
      "value": "[variables('privateDnsZoneName')]"
    },
    "logAnalyticsWorkspaceId": {
      "type": "string",
      "metadata": {
        "description": "Log Analytics Workspace ID"
      },
      "value": "[resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsWorkspaceName'))]"
    },
    "logAnalyticsWorkspaceName": {
      "type": "string",
      "metadata": {
        "description": "Log Analytics Workspace Name"
      },
      "value": "[variables('logAnalyticsWorkspaceName')]"
    },
    "natGatewayPublicIp": {
      "type": "string",
      "metadata": {
        "description": "NAT Gateway Public IP Address"
      },
      "value": "[reference(resourceId('Microsoft.Network/publicIPAddresses', variables('publicIpNatName')), '2023-11-01').ipAddress]"
    },
    "vpnGatewayPublicIp": {
      "type": "string",
      "metadata": {
        "description": "VPN Gateway Public IP Address"
      },
      "value": "[reference(resourceId('Microsoft.Network/publicIPAddresses', variables('publicIpVpnName')), '2023-11-01').ipAddress]"
    }
  }
}